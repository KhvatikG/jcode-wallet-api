# Документация Wallet API

## Обзор
REST API сервис для управления цифровыми кошельками. Сервис предоставляет эндпоинты для создания кошельков,
проверки баланса и выполнения операций пополнения/снятия средств. Построен с использованием FastAPI и PostgreSQL,
приложение контейнеризировано с помощью Docker.

## Начало работы

### Предварительные требования
- Docker и Docker Compose
- Python 3.13+

### Настройка окружения

Создайте файл `.env` в корневой директории со следующим содержимым:

```
# db
DB_HOST=postgres
DB_PORT=5432
DB_NAME=walets
DB_USER=admin
DB_PASSWORD=password

# gunicorn
WORKERS_COUNT=8
THREADS_COUNT=16
LOG_LEVEL=debug

# pool
DB_POOL_SIZE=500
DB_MAX_OVERFLOW=500
DB_POOL_TIMEOUT=30
DB_POOL_RECYCLE=1800
```

### Запуск приложения

Для запуска приложения выполните:
```bash
docker-compose up fastapi --build
```

API будет доступно по адресу `http://localhost:8000`

## Управление базой данных

### Генерация миграций
```bash

docker exec -it <имя контейнера> alembic revision --autogenerate -m "<комментарий к миграции>"
```

### Применение миграций
```bash
docker exec -it <имя контейнера> alembic upgrade head
```

## Эндпоинты API

### Создание кошелька
- **URL**: `/api/v1/wallets/create_wallet`
- **Метод**: `POST`
- **Ответ**:
  ```json
  {
    "wallet_uuid": "123e4567-e89b-12d3-a456-426614174000"
  }
  ```
- **Код состояния**: 201

### Получение баланса кошелька
- **URL**: `/api/v1/wallets/{wallet_uuid}`
- **Метод**: `GET`
- **Ответ**:
  ```json
  {
    "balance": 1000
  }
  ```
- **Код состояния**: 200

### Выполнение операции с кошельком
- **URL**: `/api/v1/wallets/{wallet_uuid}/operation`
- **Метод**: `POST`
- **Тело запроса**:
  ```json
  {
    "operation": "DEPOSIT",
    "amount": 1000
  }
  ```
  или
  ```json
  {
    "operation": "WITHDRAW",
    "amount": 1000
  }
  ```
- **Ответ**:
  ```json
  {
    "status": "success",
    "balance": 2000
  }
  ```
- **Код состояния**: 200

## Обработка ошибок

API возвращает соответствующие HTTP коды состояния и сообщения об ошибках:

- 404: Кошелек не найден
- 400: Недопустимая операция (например, недостаточно средств)
- 422: Ошибка валидации (например, неверный формат JSON)
- 500: Внутренняя ошибка сервера

## Тестирование

### Запуск тестов
```bash
docker-compose up tests --build
docker exec -it <имя контейнера tests> pytest
```

### Нагрузочное тестирование
В приложении есть конфигурация для нагрузочного тестирования с использованием Locust:
```bash
locust -f single_wallet_load_test.py --host=http://127.0.0.1:8000
```

## Производительность

Приложение разработано для обработки высокой конкурентности (1000 RPS на кошелек) со следующими особенностями:
- Управление транзакциями базы данных, а также атомарность операций для предотвращения race condition
- Пулинг соединений для оптимальной производительности базы данных
- Проверки работоспособности для подключения к базе данных
- Корректная обработка ошибок и форматирование ответов

## Конфигурация

Приложение может быть настроено через переменные окружения без пересборки контейнеров. Основные параметры конфигурации включают:
- Параметры подключения к базе данных
- Количество рабочих процессов сервера
- Количество потоков
- Конфигурация пула sqlalchemy
- Конфигурация БД - файл postgresql.conf

## Архитектура

В приложении используются:
- FastAPI для REST API
- PostgreSQL для хранения данных
- Alembic для миграций базы данных
- Docker и Docker Compose для контейнеризации
- Gunicorn с Uvicorn workers для production-развертывания
- pytest для тестирования
- Locust для нагрузочного тестирования

## Docker сервисы

Конфигурация docker-compose включает:
- `fastapi`: Основной сервис приложения
- `postgres`: Production база данных
- `test_db`: Отдельная база данных для тестирования
- `tests`: Сервис для запуска тестов
